<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>My Schedule - <%= day %></title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }
      .top-nav {
        background-color: #222;
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
      }
      .top-nav a {
        color: #bbb;
        margin-right: 15px;
        text-decoration: none;
      }
      .top-nav a:hover { color: #fff; }
      .main-content { padding: 20px; }
      .day-form { margin-bottom: 10px; }
      /* Split container: left for free rooms, right for calendar */
      .split-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }
      .left-panel { width: 400px; }
      .right-panel { flex: 1; }
      .calendar-wrapper { display: flex; gap: 10px; }
      .time-axis {
        position: relative;
        width: 60px;
        height: <%= calendarHeight + 20 %>px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        padding-top: 10px;
        box-sizing: border-box;
      }
      .time-label {
        position: absolute;
        left: 0; width: 100%;
        text-align: right;
        padding-right: 5px;
        font-size: 12px;
        box-sizing: border-box;
      }
      .calendar-container {
        position: relative;
        width: 600px;
        height: <%= calendarHeight + 20 %>px;
        border: 1px solid #ccc;
        background-color: #fafcff;
        overflow: hidden;
        padding-top: 10px;
        box-sizing: border-box;
        cursor: pointer;
      }
      .booking {
        position: absolute;
        left: 0; right: 0;
        background-color: rgba(240, 90, 76, 0.3);
        border: 1px solid #0070f3;
        padding: 2px;
        box-sizing: border-box;
        font-size: 12px;
        z-index: 1;
      }
      .hour-line {
        position: absolute;
        left: 0;
        width: 100%;
        border-top: 1px solid #ddd;
        pointer-events: none;
        z-index: 0;
      }
      /* Free Rooms panel styling */
      .details-panel {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        max-width: 400px;
      }
      details {
        margin-bottom: 10px;
      }
      details summary {
        font-weight: bold;
        cursor: pointer;
      }
      details ul {
        list-style: none;
        margin: 0;
        padding-left: 15px;
      }
      details ul li {
        margin: 2px 0;
      }
      .room-link {
        color: #0070f3;
        text-decoration: none;
      }
      .room-link:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <div class="top-nav">
      <div>
        <a href="/home">Home</a>
        <a href="/schedule">Your Schedule</a>
        <a href="/pickaroom">Pick a Room</a>
      </div>
      <div>April 11th, 2025 (Friday)</div>
    </div>

    <div class="main-content">
      <h1>My Schedule for <%= day %></h1>
      <form class="day-form" method="GET" action="/home">
        <select name="day">
          <option value="Monday"    <%= day==="Monday" ? "selected" : "" %>>Monday</option>
          <option value="Tuesday"   <%= day==="Tuesday" ? "selected" : "" %>>Tuesday</option>
          <option value="Wednesday" <%= day==="Wednesday" ? "selected" : "" %>>Wednesday</option>
          <option value="Thursday"  <%= day==="Thursday" ? "selected" : "" %>>Thursday</option>
          <option value="Friday"    <%= day==="Friday" ? "selected" : "" %>>Friday</option>
        </select>
        <button type="submit">Show</button>
      </form>

      <div class="split-container">
        <!-- LEFT PANEL: Free Rooms details -->
        <div class="left-panel">
          <div class="details-panel" id="detailsPanel">
            <h3>Free Rooms</h3>
            <p>Click on an empty spot in the calendar to see which rooms are free at that time.</p>
            <div id="freeRoomsList"></div>
          </div>
        </div>

        <!-- RIGHT PANEL: Calendar -->
        <div class="right-panel">
          <div class="calendar-wrapper">
            <!-- TIME AXIS -->
            <div class="time-axis">
              <% for (let t = 420; t <= 1320; t += 60) {
                  let hour = Math.floor(t / 60);
                  let ampm = hour >= 12 ? "PM" : "AM";
                  let displayHour = (hour % 12) || 12;
                  let offset = (t - 420) * 0.5;
              %>
                <div class="time-label" style="top: <%= offset + 10 - 6 %>px;">
                  <%= displayHour + ":00" + ampm %>
                </div>
              <% } %>
            </div>

            <!-- CALENDAR AREA -->
            <div class="calendar-container" id="calendarContainer">
              <% for (let t = 420; t <= 1320; t += 60) {
                  let offset = (t - 420) * 0.5;
              %>
                <div class="hour-line" style="top:<%= offset + 10 %>px;"></div>
              <% } %>
              <% bookings.forEach(function(b) { %>
                <div class="booking" style="top:<%= b.top + 10 %>px; height:<%= b.height %>px;" onclick="event.stopPropagation()">
                  <strong><%= b.className %></strong><br/>
                  <%= b.timeRange %>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Define groupKeywords for grouping room names.
      const groupKeywords = [
        "Cowell Acad",
        "Cowell Clrm",
        "Commun Bldg",
        "Crown Clrm",
        "Earth&Marine",
        "Elena Baskin Arts",
        "Engineer 2",
        "ISB",
        "J Baskin Engr",
        "Kresge Acad",
        "McHenry Clrm",
        "McHenry Lib",
        "Media Theater",
        "Merrill Acad",
        "Nat Sci",
        "Oakes Acad",
        "PhysSciences",
        "Porter Acad",
        "R Carson Acad",
        "Soc Sci",
        "Steven Acad",
        "Thim Lecture",
        "Thimann Lab"
      ];

      // Group the list of rooms (an array of strings).
      function groupRooms(rooms) {
        const groups = {};
        const others = [];
        rooms.forEach(room => {
          let matched = false;
          for (let keyword of groupKeywords) {
            if (room.startsWith(keyword)) {
              if (!groups[keyword]) groups[keyword] = [];
              groups[keyword].push(room);
              matched = true;
              break;
            }
          }
          if (!matched) {
            others.push(room);
          }
        });
        for (let group in groups) {
          groups[group].sort((a, b) => a.localeCompare(b));
        }
        others.sort((a, b) => a.localeCompare(b));
        return { groups, others };
      }

      const calendarContainer = document.getElementById("calendarContainer");
      const freeRoomsList = document.getElementById("freeRoomsList");
      const currentDay = "<%= day %>";

      // When user clicks on an empty spot in the calendar,
      // fetch free rooms from the server and display them grouped.
      calendarContainer.addEventListener("click", async function(e) {
        const rect = calendarContainer.getBoundingClientRect();
        const clickY = e.clientY - rect.top;
        const adjustedY = clickY - 10; // subtract top padding
        const minutesFrom7AM = adjustedY / 0.5;
        const totalMinutes = Math.round(minutesFrom7AM);
        const hours = Math.floor(totalMinutes / 60) + 7;
        const mins = totalMinutes % 60;
        const period = (hours >= 12) ? "PM" : "AM";
        const displayHour = hours % 12 || 12;
        const displayMins = mins.toString().padStart(2, "0");
        const timeStr = displayHour + ":" + displayMins + period;

        try {
          const response = await fetch(`/home/freerooms?day=${currentDay}&time=${encodeURIComponent(timeStr)}`);
          const rooms = await response.json();
          const { groups, others } = groupRooms(rooms);
          let html = `<p>You clicked at: <strong>${timeStr}</strong> on <strong>${currentDay}</strong></p><p>Free Rooms:</p>`;

          // For each group, output as a <details> block.
          for (let group in groups) {
            html += `<details><summary>${group} (${groups[group].length})</summary><ul>`;
            groups[group].forEach(r => {
              const link = `/pickaroom?day=${encodeURIComponent(currentDay)}&location=${encodeURIComponent(r)}`;
              html += `<li><a class="room-link" href="${link}">${r}</a></li>`;
            });
            html += `</ul></details>`;
          }
          // Group others in a <details> block.
          if (others.length > 0) {
            html += `<details open><summary>Others (${others.length})</summary><ul>`;
            others.forEach(r => {
              const link = `/pickaroom?day=${encodeURIComponent(currentDay)}&location=${encodeURIComponent(r)}`;
              html += `<li><a class="room-link" href="${link}">${r}</a></li>`;
            });
            html += `</ul></details>`;
          }
          freeRoomsList.innerHTML = html;
        } catch (err) {
          freeRoomsList.innerHTML = `<p>Error fetching free rooms: ${err.message}</p>`;
        }
      });
    </script>
  </body>
</html>
